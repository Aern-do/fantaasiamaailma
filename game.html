<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap");
    </style>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BOW — Esileht</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <header>
      <div class="container topbar">
        <a class="logo" href="index.html">
          <div class="logomark"><strong>BOW</strong></div>
          <div>
            <div class="site-title">BOW</div>
            <div class="site-sub">Pudelrahvaste ajastu</div>
          </div>
        </a>
        <nav class="navlinks">
          <a href="uudised.html">Uudised</a>
          <a href="maailmakaart.html">Maailmakaart</a>
          <a href="lore.html">Lore</a>
          <a class="btn btn-ghost" href="game.html">Mäng</a>
        </nav>
      </div>
    </header>

    <main class="container" style="display: flex; justify-content: center">
      <canvas id="gameCanvas" width="850" height="675"></canvas>
    </main>

    <audio id="bgMusic" loop preload="auto">
      <source src="./audio/ost.mp3#t=00:01:20" type="audio/mpeg" />
      Your browser does not support the audio tag.
    </audio>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      let bottles = [];
      let particles = [];
      let score = 0;
      let mouse = { x: canvas.width / 2, y: canvas.height / 2 };

      const bottleImg = new Image();
      bottleImg.src =
        "https://png.pngtree.com/png-clipart/20240418/original/pngtree-compressed-plastic-bottle-png-image_14879043.png";

      const bottle2Img = new Image();
      bottle2Img.src =
        "https://static.vecteezy.com/system/resources/previews/050/091/562/non_2x/plastic-bottle-of-water-free-png.png";

      const bottle3Img = new Image();
      bottle3Img.src =
        "https://www.freeiconspng.com/uploads/water-bottle-png-10.png";

      const bottleImages = [bottleImg, bottle2Img, bottle3Img];

      const bgImg = new Image();
      bgImg.src = "./pictures/gameBg.png";

      const bgMusic = document.getElementById("bgMusic");
      const breakMusic = document.getElementById("breakMusic");

      document.addEventListener("click", () => {
        if (bgMusic.paused) {
          bgMusic.volume = 0.3;
          bgMusic.play();
        }
      });

      let flash = { alpha: 0 };

      class Particle {
        constructor(x, y, color) {
          this.x = x;
          this.y = y;

          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 15 + 5;
          this.vx = Math.cos(angle) * speed;
          this.vy = Math.sin(angle) * speed;

          this.size = Math.random() * 5 + 2;
          this.alpha = 1;
          this.color = color;
          this.gravity = 0.3;
        }

        update() {
          this.vy += this.gravity;
          this.x += this.vx;
          this.y += this.vy;
          this.alpha -= 0.008;
        }

        draw() {
          ctx.globalAlpha = this.alpha;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
          ctx.globalAlpha = 1;
        }
      }

      class Bottle {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.vy = -(5 + Math.random() * 3);
          this.vx = (2 + Math.random() - 0.5) * 0.6;
          this.width = 82;
          this.height = 82;
          this.gravity = 0.05;
          this.dead = false;
          this.image =
            bottleImages[Math.floor(Math.random() * bottleImages.length)];

          this.rotation = 0;
          this.spinSpeed = (Math.random() - 0.5) * 0.15;
        }

        update() {
          this.vy += this.gravity;
          this.y += this.vy;
          this.x += this.vx;
          this.rotation += this.spinSpeed;

          if (this.x < 25 || this.x > canvas.width - 25) {
            this.vx *= -1;
          }

          if (this.y > canvas.height + 50) {
            score -= 1;
            this.dead = true;
          }
        }

        draw() {
          ctx.save();
          ctx.translate(this.x, this.y - this.height / 2);
          ctx.rotate(this.rotation);
          ctx.drawImage(
            this.image,
            -this.width / 2,
            -this.height / 2,
            this.width,
            this.height
          );
          ctx.restore();
        }

        isHit(mx, my) {
          return (
            mx > this.x - this.width / 2 &&
            mx < this.x + this.width / 2 &&
            my > this.y - this.height &&
            my < this.y
          );
        }
      }

      let ripples = [];

      class Ripple {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.radius = 10;
          this.alpha = 0.6;
        }
        update() {
          this.radius += 5;
          this.alpha -= 0.02;
        }
        draw() {
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.strokeStyle = `rgba(173, 216, 230, ${this.alpha})`;
          ctx.lineWidth = 3;
          ctx.stroke();
        }
      }

      canvas.addEventListener("mousemove", (e) => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.clientX - rect.left;
        mouse.y = e.clientY - rect.top;
      });

      canvas.addEventListener("click", () => {
        for (let i = bottles.length - 1; i >= 0; i--) {
          if (bottles[i].isHit(mouse.x, mouse.y)) {
            let hitX = bottles[i].x;
            let hitY = bottles[i].y - bottles[i].height / 2;

            let particleCount = Math.floor(180 + Math.random() * 400);

            for (let p = 0; p < particleCount; p++) {
              let colors = ["#aef", "#9cf", "#6ff", "white", "lightblue"];
              let color = colors[Math.floor(Math.random() * colors.length)];
              particles.push(new Particle(hitX, hitY, color));
            }

            bottles.splice(i, 1);
            score++;

            let sfx = new Audio("./audio/break.mp3");
            sfx.volume = 0.5;
            sfx.play().catch((e) => console.log("Play error:", e));

            ripples.push(new Ripple(hitX, hitY));
            shakeScreen();
            flash.alpha = 0.7;

            break;
          }
        }
      });

      function spawnBottle() {
        const x = Math.random() * (canvas.width - 50) + 25;
        const y = canvas.height - 30;
        bottles.push(new Bottle(x, y));
      }
      setInterval(spawnBottle, 1800);

      let shake = { x: 0, y: 0, intensity: 0 };

      function shakeScreen() {
        shake.intensity = Math.floor(96 + Math.random() * 360);
      }

      function applyShake() {
        if (shake.intensity > 0) {
          shake.x = (Math.random() - 0.4) * shake.intensity;
          shake.y = (Math.random() - 0.3) * shake.intensity;
          shake.intensity *= 0.95;
        } else {
          shake.x = 0;
          shake.y = 0;
        }
      }

      function gameLoop() {
        applyShake();
        ctx.setTransform(1, 0, 0, 1, shake.x, shake.y);
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (flash.alpha > 0) {
          ctx.fillStyle = `rgba(255, 255, 255, ${flash.alpha})`;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          flash.alpha -= 0.025;
        }

        for (let i = bottles.length - 1; i >= 0; i--) {
          bottles[i].update();
          bottles[i].draw();
          if (bottles[i].dead) bottles.splice(i, 1);
        }

        for (let i = particles.length - 1; i >= 0; i--) {
          const part = particles[i];
          part.update();
          part.draw();
          if (part.alpha <= 0) {
            particles.splice(i, 1);
          }
        }

        for (let i = ripples.length - 1; i >= 0; i--) {
          ripples[i].update();
          ripples[i].draw();
          if (ripples[i].alpha <= 0) ripples.splice(i, 1);
        }

        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(mouse.x - 25, mouse.y);
        ctx.lineTo(mouse.x + 25, mouse.y);
        ctx.moveTo(mouse.x, mouse.y - 25);
        ctx.lineTo(mouse.x, mouse.y + 25);
        ctx.stroke();

        ctx.fillStyle = "white";
        ctx.font = "20px Orbitron, sans-serif";
        ctx.fillText("Score: " + score, 20, 30);

        ctx.setTransform(1, 0, 0, 1, 0, 0);
        requestAnimationFrame(gameLoop);
      }

      bottleImg.onload = () => {
        gameLoop();
      };
    </script>
  </body>
</html>
